#####################################################################
#                  Mellow LLL Filament Plus Buffer
#####################################################################

[mcu LLL_PLUS]
serial: /dev/serial/by-id/usb-Klipper_<YOUR_MCU_ID_HERE>-if00
restart_method: command

#####################################################################
#                       Buffer Extruder Configuration
#####################################################################

[extruder1]
step_pin: LLL_PLUS:PC13
dir_pin: LLL_PLUS:PA7
enable_pin: !LLL_PLUS:PA6
microsteps: 16
gear_ratio: 50:17
rotation_distance: 18.86
nozzle_diameter: 0.4
filament_diameter: 1.75
max_extrude_only_distance: 1000
min_extrude_temp: 0
# Dummy heater configuration
heater_pin: LLL_PLUS:PA0
sensor_type: temperature_mcu
sensor_mcu: LLL_PLUS
control: pid
pid_Kp: 1.0
pid_Ki: 1.0
pid_Kd: 1.0
min_temp: 0
max_temp: 100

[tmc2208 extruder1]
uart_pin: LLL_PLUS:PB1
run_current: 0.35
stealthchop_threshold: 999999

#####################################################################
#                  Manual Feed/Retract Buttons
#####################################################################

[gcode_button feed_button]
pin: ^!LLL_PLUS:PB12
press_gcode:
    M118 Feed button pressed - starting continuous feed
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=manual_operation VALUE=1
    UPDATE_DELAYED_GCODE ID=_buffer_feed_loop DURATION=0
    SET_GCODE_VARIABLE MACRO=_MANUAL_FEED VARIABLE=active VALUE=1
    _MANUAL_FEED
release_gcode:
    M118 Feed button released
    SET_GCODE_VARIABLE MACRO=_MANUAL_FEED VARIABLE=active VALUE=0
    UPDATE_DELAYED_GCODE ID=_manual_feed_loop DURATION=0
    UPDATE_DELAYED_GCODE ID=_reenable_autofeed DURATION=2

[gcode_button retract_button]
pin: ^!LLL_PLUS:PB13
press_gcode:
    M118 Retract button pressed - starting continuous retract
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=manual_operation VALUE=1
    UPDATE_DELAYED_GCODE ID=_buffer_feed_loop DURATION=0
    SET_GCODE_VARIABLE MACRO=_MANUAL_RETRACT VARIABLE=active VALUE=1
    _MANUAL_RETRACT
release_gcode:
    M118 Retract button released
    SET_GCODE_VARIABLE MACRO=_MANUAL_RETRACT VARIABLE=active VALUE=0
    UPDATE_DELAYED_GCODE ID=_manual_retract_loop DURATION=0
    UPDATE_DELAYED_GCODE ID=_reenable_autofeed DURATION=2

#####################################################################
#                  Manual Control Macros
#####################################################################

[gcode_macro _MANUAL_FEED]
variable_active: 0
gcode:
    {% if active == 1 %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder1
        M83
        G1 E10 F3000
        UPDATE_DELAYED_GCODE ID=_manual_feed_loop DURATION=0.18
    {% endif %}

[delayed_gcode _manual_feed_loop]
gcode:
    _MANUAL_FEED

[gcode_macro _MANUAL_RETRACT]
variable_active: 0
gcode:
    {% if active == 1 %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder1
        M83
        G1 E-10 F3000
        UPDATE_DELAYED_GCODE ID=_manual_retract_loop DURATION=0.18
    {% endif %}

[delayed_gcode _manual_retract_loop]
gcode:
    _MANUAL_RETRACT

#####################################################################
#                  Buffer Automatic Control System
#####################################################################

# Filament entrance sensor - enables/disables auto-feed system
[filament_switch_sensor buffer_entrance]
switch_pin: ^!LLL_PLUS:PB7
pause_on_runout: False
insert_gcode:
    M118 Buffer: Filament detected, starting initial fill
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=system_enabled VALUE=1
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=manual_operation VALUE=0
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=overfill_lock VALUE=0
    # Start continuous feed to fill buffer initially
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=continuous_feed VALUE=1
    _BUFFER_AUTO_CONTROL
runout_gcode:
    M118 Buffer: Filament runout detected at entrance
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=system_enabled VALUE=0
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=continuous_feed VALUE=0
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=overfill_lock VALUE=0
    UPDATE_DELAYED_GCODE ID=_buffer_feed_loop DURATION=0

# HALL3 - Initial fill complete sensor (neck fully retracted)
[gcode_button buffer_hall3]
pin: ^!LLL_PLUS:PB4
press_gcode:
    M118 HALL3 TRIGGERED - Initial fill complete, switching to burst mode
    # Stop continuous feeding, switch to burst mode controlled by HALL2
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=continuous_feed VALUE=0
    UPDATE_DELAYED_GCODE ID=_buffer_feed_loop DURATION=0
release_gcode:
    M118 HALL3 RELEASED - Neck retracted (normal during operation)

# HALL2 - Primary buffer control (mid-point trigger)
[gcode_button buffer_hall2]
pin: ^!LLL_PLUS:PB3
press_gcode:
    M118 HALL2 TRIGGERED - Neck retracted, buffer OK
release_gcode:
    M118 HALL2 RELEASED - Neck extended to mid-point
    {% if printer["gcode_macro _BUFFER_AUTO_CONTROL"].manual_operation == 0 %}
        {% if printer["gcode_macro _BUFFER_AUTO_CONTROL"].system_enabled == 1 %}
            {% if printer["gcode_macro _BUFFER_AUTO_CONTROL"].overfill_lock == 0 %}
                M118 Buffer: Executing feed burst
                _BUFFER_FEED_BURST
            {% else %}
                M118 Buffer: Overfill lock active, skipping burst
            {% endif %}
        {% endif %}
    {% else %}
        M118 Buffer: Manual operation in progress, skipping burst
    {% endif %}

# HALL1 - Overfill limiter (neck extended to maximum)
[gcode_button buffer_hall1]
pin: ^!LLL_PLUS:PB2
press_gcode:
    M118 HALL1 TRIGGERED - Neck returning to safe zone, re-enabling buffer
    # Clear overfill lock when neck retracts
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=overfill_lock VALUE=0
release_gcode:
    M118 ⚠️ HALL1 RELEASED - Buffer overfill detected, pausing auto-feed
    # Set overfill lock to prevent feeding
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=overfill_lock VALUE=1
    # Stop any continuous feeding
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=continuous_feed VALUE=0
    UPDATE_DELAYED_GCODE ID=_buffer_feed_loop DURATION=0

#####################################################################
#                  Buffer Control Macros
#####################################################################

[gcode_macro _BUFFER_AUTO_CONTROL]
variable_system_enabled: 0
variable_continuous_feed: 0
variable_manual_operation: 0
variable_overfill_lock: 0
gcode:
    # Continuous feed mode (initial fill only) - stops if overfill lock is active
    {% if system_enabled == 1 and continuous_feed == 1 and manual_operation == 0 and overfill_lock == 0 %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder1
        M83
        G1 E10 F3000
        UPDATE_DELAYED_GCODE ID=_buffer_feed_loop DURATION=0.18
    {% endif %}

[delayed_gcode _buffer_feed_loop]
gcode:
    _BUFFER_AUTO_CONTROL

[gcode_macro _BUFFER_FEED_BURST]
gcode:
    # Small burst feed when HALL2 triggers (only if overfill lock is not active)
    {% if printer["gcode_macro _BUFFER_AUTO_CONTROL"].overfill_lock == 0 %}
        ACTIVATE_EXTRUDER EXTRUDER=extruder1
        M83
        G1 E15 F3000
        M118 Buffer: Feed burst complete
    {% else %}
        M118 Buffer: Burst cancelled due to overfill lock
    {% endif %}

[delayed_gcode _reenable_autofeed]
gcode:
    M118 Re-enabling auto-feed system
    SET_GCODE_VARIABLE MACRO=_BUFFER_AUTO_CONTROL VARIABLE=manual_operation VALUE=0
